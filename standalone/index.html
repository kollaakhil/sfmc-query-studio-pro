<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SFMC Query Studio Pro</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--bg:#1E1E2E;--surface:#282A36;--surface2:#313244;--border:#44475A;
--text:#F8F8F2;--text-muted:#6272A4;--accent:#BD93F9;
--kw:#FF79C6;--fn:#8BE9FD;--sfmc-fn:#FFB86C;--dv:#50FA7B;
--str:#F1FA8C;--num:#BD93F9;--cmt:#6272A4;--op:#FF5555;
--bracket:#F8F8F2;--ident:#F8F8F2;--line-num:#6272A4;
--btn-hover:rgba(255,255,255,0.08);--btn-active:rgba(255,255,255,0.12);
--scrollbar:#44475A;--scrollbar-hover:#6272A4;
--caret-color:#F8F8F2;--selection:rgba(189,147,249,0.3);
--panel-bg:#21222C;--card-bg:#2B2D3A;--card-hover:#343648;
--success:#50FA7B;--warning:#FFB86C;--danger:#FF5555;--info:#8BE9FD;
}
[data-theme="light"]{
--bg:#F5F5F5;--surface:#FFFFFF;--surface2:#E8E8E8;--border:#D0D0D0;
--text:#1E1E1E;--text-muted:#6A737D;--accent:#6F42C1;
--kw:#0000FF;--fn:#795E26;--sfmc-fn:#AF00DB;--dv:#267F99;
--str:#A31515;--num:#098658;--cmt:#008000;--op:#000000;
--bracket:#1E1E1E;--ident:#1E1E1E;--line-num:#999999;
--btn-hover:rgba(0,0,0,0.06);--btn-active:rgba(0,0,0,0.1);
--scrollbar:#C0C0C0;--scrollbar-hover:#999;
--caret-color:#1E1E1E;--selection:rgba(0,0,255,0.15);
--panel-bg:#EBEBEB;--card-bg:#FFFFFF;--card-hover:#F0F0F0;
--success:#22863A;--warning:#B08800;--danger:#D73A49;--info:#005CC5;
}
html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text)}
body{display:flex;flex-direction:column;overflow:hidden}

/* Scrollbar */
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--scrollbar);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(--scrollbar-hover)}

/* Header */
.header{display:flex;align-items:center;padding:8px 16px;background:var(--surface);border-bottom:1px solid var(--border);gap:12px;flex-shrink:0;min-height:48px}
.logo{font-size:16px;font-weight:700;color:var(--accent);white-space:nowrap;display:flex;align-items:center;gap:6px}
.logo svg{width:20px;height:20px}

/* Toolbar */
.toolbar{display:flex;align-items:center;gap:2px;flex-wrap:wrap;flex:1}
.tb-sep{width:1px;height:24px;background:var(--border);margin:0 6px;flex-shrink:0}
.tb-btn{display:inline-flex;align-items:center;gap:5px;padding:5px 10px;border:none;background:transparent;color:var(--text);font-size:12px;border-radius:4px;cursor:pointer;white-space:nowrap;transition:background .15s}
.tb-btn:hover{background:var(--btn-hover)}
.tb-btn:active{background:var(--btn-active)}
.tb-btn svg{width:14px;height:14px;flex-shrink:0}
.tb-btn.active{background:var(--btn-active);color:var(--accent)}

/* Main Layout */
.main{display:flex;flex:1;overflow:hidden}

/* Side Panel */
.side-panel{width:320px;background:var(--panel-bg);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;transition:width .2s}
.side-panel.collapsed{width:0;border:none}
.panel-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0}
.panel-tab{flex:1;padding:8px 4px;text-align:center;font-size:11px;font-weight:600;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;text-transform:uppercase;letter-spacing:.5px}
.panel-tab:hover{color:var(--text);background:var(--btn-hover)}
.panel-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.panel-content{flex:1;overflow-y:auto;padding:8px}
.panel-section{display:none}
.panel-section.active{display:block}

/* Search Input */
.panel-search{width:100%;padding:7px 10px;background:var(--surface);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:12px;margin-bottom:8px;outline:none}
.panel-search:focus{border-color:var(--accent)}
.panel-search::placeholder{color:var(--text-muted)}

/* Template Cards */
.tpl-card{padding:10px 12px;background:var(--card-bg);border:1px solid var(--border);border-radius:6px;margin-bottom:6px;cursor:pointer;transition:all .15s}
.tpl-card:hover{background:var(--card-hover);border-color:var(--accent);transform:translateX(2px)}
.tpl-card h4{font-size:12px;font-weight:600;margin-bottom:3px;color:var(--text)}
.tpl-card p{font-size:11px;color:var(--text-muted);line-height:1.4}

/* Snippets */
.snippet-item{display:flex;align-items:center;padding:8px 10px;background:var(--card-bg);border:1px solid var(--border);border-radius:6px;margin-bottom:6px;cursor:pointer;transition:all .15s;gap:8px}
.snippet-item:hover{background:var(--card-hover);border-color:var(--accent)}
.snippet-item .sn-name{flex:1;font-size:12px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.snippet-item .sn-date{font-size:10px;color:var(--text-muted);white-space:nowrap}
.snippet-item .sn-del{background:none;border:none;color:var(--danger);cursor:pointer;font-size:14px;padding:2px 4px;border-radius:3px;opacity:.6;transition:opacity .15s}
.snippet-item .sn-del:hover{opacity:1}

/* Data Views Accordion */
.dv-group{margin-bottom:4px}
.dv-header{padding:8px 10px;background:var(--card-bg);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;color:var(--dv);display:flex;align-items:center;justify-content:space-between;transition:all .15s}
.dv-header:hover{background:var(--card-hover)}
.dv-header .arrow{transition:transform .2s;font-size:10px;color:var(--text-muted)}
.dv-group.open .dv-header .arrow{transform:rotate(90deg)}
.dv-fields{display:none;padding:4px 0 4px 12px}
.dv-group.open .dv-fields{display:block}
.dv-field{padding:4px 8px;font-size:11px;cursor:pointer;border-radius:3px;display:flex;align-items:center;gap:6px;transition:background .1s}
.dv-field:hover{background:var(--btn-hover)}
.dv-field .f-name{color:var(--text);font-weight:500}
.dv-field .f-type{color:var(--text-muted);font-size:10px}

/* History */
.hist-item{padding:8px 10px;background:var(--card-bg);border:1px solid var(--border);border-radius:6px;margin-bottom:6px;cursor:pointer;transition:all .15s}
.hist-item:hover{background:var(--card-hover);border-color:var(--accent)}
.hist-item .h-preview{font-size:11px;color:var(--text);font-family:'SF Mono',SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:3px}
.hist-item .h-time{font-size:10px;color:var(--text-muted)}

/* Editor Area */
.editor-area{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}

/* Editor Container */
.editor-wrap{flex:1;position:relative;overflow:hidden;background:var(--surface)}
.line-numbers{position:absolute;left:0;top:0;bottom:0;width:48px;background:var(--surface);border-right:1px solid var(--border);padding:12px 8px 12px 0;text-align:right;font-family:'SF Mono',SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-size:13px;line-height:1.6;color:var(--line-num);overflow:hidden;z-index:2;user-select:none;pointer-events:none}
.editor-scroll{position:absolute;left:48px;top:0;right:0;bottom:0;overflow:auto}
.highlight-layer{position:absolute;top:0;left:0;right:0;padding:12px 16px;font-family:'SF Mono',SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-size:13px;line-height:1.6;white-space:pre-wrap;word-wrap:break-word;color:var(--text);pointer-events:none;min-height:100%}
.editor-textarea{position:absolute;top:0;left:0;width:100%;height:100%;padding:12px 16px;font-family:'SF Mono',SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-size:13px;line-height:1.6;color:transparent;caret-color:var(--caret-color);background:transparent;border:none;outline:none;resize:none;white-space:pre-wrap;word-wrap:break-word;overflow:hidden;z-index:1;tab-size:4;-moz-tab-size:4}
.editor-textarea::selection{background:var(--selection)}

/* Syntax Colors */
.syn-keyword{color:var(--kw);font-weight:600}
.syn-function{color:var(--fn)}
.syn-sfmc-function{color:var(--sfmc-fn)}
.syn-dataview{color:var(--dv)}
.syn-string{color:var(--str)}
.syn-number{color:var(--num)}
.syn-comment{color:var(--cmt);font-style:italic}
.syn-operator{color:var(--op)}
.syn-bracket{color:var(--bracket)}
.syn-identifier{color:var(--ident)}

/* Status Bar */
.status-bar{display:flex;align-items:center;justify-content:space-between;padding:4px 16px;background:var(--surface);border-top:1px solid var(--border);font-size:11px;color:var(--text-muted);flex-shrink:0;min-height:28px;gap:12px}
.status-left,.status-right{display:flex;align-items:center;gap:12px}
.status-badge{padding:1px 8px;background:var(--accent);color:#fff;border-radius:3px;font-size:10px;font-weight:600;letter-spacing:.5px}
.theme-toggle{background:none;border:1px solid var(--border);color:var(--text-muted);cursor:pointer;padding:2px 8px;border-radius:3px;font-size:11px;transition:all .15s}
.theme-toggle:hover{color:var(--text);border-color:var(--text-muted)}

/* Find & Replace */
.find-bar{display:none;padding:6px 12px;background:var(--surface2);border-bottom:1px solid var(--border);gap:8px;align-items:center;flex-shrink:0}
.find-bar.visible{display:flex}
.find-bar input{padding:4px 8px;background:var(--surface);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px;outline:none;width:200px}
.find-bar input:focus{border-color:var(--accent)}
.find-bar button{padding:4px 10px;background:var(--btn-hover);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:11px;cursor:pointer}
.find-bar button:hover{background:var(--btn-active)}
.find-bar .find-close{background:none;border:none;color:var(--text-muted);font-size:16px;cursor:pointer;padding:0 4px}
.find-bar .find-count{font-size:11px;color:var(--text-muted);min-width:60px}

/* Save Dialog */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:100;align-items:center;justify-content:center}
.modal-overlay.visible{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:20px;width:360px;max-width:90vw}
.modal h3{margin-bottom:12px;font-size:14px}
.modal input{width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px;outline:none;margin-bottom:12px}
.modal input:focus{border-color:var(--accent)}
.modal-btns{display:flex;gap:8px;justify-content:flex-end}
.modal-btns button{padding:6px 16px;border-radius:4px;border:1px solid var(--border);cursor:pointer;font-size:12px}
.modal-btns .btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.modal-btns .btn-cancel{background:transparent;color:var(--text)}

/* Toast */
.toast{position:fixed;bottom:48px;right:16px;padding:10px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--text);z-index:200;opacity:0;transform:translateY(10px);transition:all .3s;pointer-events:none}
.toast.visible{opacity:1;transform:translateY(0)}
.toast.success{border-color:var(--success);color:var(--success)}
.toast.error{border-color:var(--danger);color:var(--danger)}

/* Responsive */
@media(max-width:768px){
.side-panel{position:absolute;z-index:50;height:100%;width:280px !important;left:0;top:0}
.side-panel.collapsed{width:0 !important}
.tb-btn span{display:none}
.header{padding:8px}
}
</style>
</head>
<body>

<!-- Header & Toolbar -->
<div class="header">
  <div class="logo">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 8h6M9 12h6M9 16h4"/></svg>
    SFMC Query Studio Pro
  </div>
  <div class="toolbar">
    <button class="tb-btn" onclick="togglePanel()" title="Toggle Panel (Ctrl+B)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
      <span>Panel</span>
    </button>
    <div class="tb-sep"></div>
    <button class="tb-btn" onclick="formatSQL()" title="Format SQL (Ctrl+Shift+F)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16M4 12h10M4 17h14"/></svg>
      <span>Format</span>
    </button>
    <button class="tb-btn" onclick="copyToClipboard()" title="Copy (Ctrl+C)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
      <span>Copy</span>
    </button>
    <div class="tb-sep"></div>
    <button class="tb-btn" onclick="showSaveDialog()" title="Save Snippet (Ctrl+S)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>
      <span>Save</span>
    </button>
    <button class="tb-btn" onclick="exportSQL()" title="Export .sql">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      <span>Export</span>
    </button>
    <button class="tb-btn" onclick="importSQL()" title="Import .sql">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      <span>Import</span>
    </button>
    <div class="tb-sep"></div>
    <button class="tb-btn" onclick="toggleFind()" title="Find & Replace (Ctrl+F)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <span>Find</span>
    </button>
    <button class="tb-btn" onclick="clearEditor()" title="Clear">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
      <span>Clear</span>
    </button>
  </div>
</div>

<!-- Find & Replace Bar -->
<div class="find-bar" id="findBar">
  <input type="text" id="findInput" placeholder="Find..." oninput="doFind()">
  <input type="text" id="replaceInput" placeholder="Replace...">
  <button onclick="doReplace()">Replace</button>
  <button onclick="doReplaceAll()">All</button>
  <span class="find-count" id="findCount"></span>
  <button class="find-close" onclick="toggleFind()">&times;</button>
</div>

<!-- Main Content -->
<div class="main">
  <!-- Side Panel -->
  <div class="side-panel" id="sidePanel">
    <div class="panel-tabs">
      <div class="panel-tab active" onclick="switchPanelTab('templates')">Templates</div>
      <div class="panel-tab" onclick="switchPanelTab('snippets')">Snippets</div>
      <div class="panel-tab" onclick="switchPanelTab('dataviews')">Data Views</div>
      <div class="panel-tab" onclick="switchPanelTab('history')">History</div>
    </div>
    <div class="panel-content">
      <div class="panel-section active" id="sec-templates">
        <input class="panel-search" id="tplSearch" placeholder="Search templates..." oninput="filterTemplates()">
        <div id="tplList"></div>
      </div>
      <div class="panel-section" id="sec-snippets">
        <div id="snippetList"></div>
      </div>
      <div class="panel-section" id="sec-dataviews">
        <input class="panel-search" id="dvSearch" placeholder="Search data views..." oninput="filterDataViews()">
        <div id="dvList"></div>
      </div>
      <div class="panel-section" id="sec-history">
        <div id="histList"></div>
      </div>
    </div>
  </div>

  <!-- Editor -->
  <div class="editor-area">
    <div class="editor-wrap">
      <div class="line-numbers" id="lineNumbers"></div>
      <div class="editor-scroll" id="editorScroll">
        <div class="highlight-layer" id="highlightLayer"></div>
        <textarea class="editor-textarea" id="editor" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
      </div>
    </div>
  </div>
</div>

<!-- Status Bar -->
<div class="status-bar">
  <div class="status-left">
    <span id="statusLines">Ln 1</span>
    <span id="statusCol">Col 1</span>
    <span id="statusChars">0 chars</span>
    <span id="statusLineCount">1 line</span>
  </div>
  <div class="status-right">
    <span class="status-badge">SFMC SQL</span>
    <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">&#9790; Dark</button>
  </div>
</div>

<!-- Save Modal -->
<div class="modal-overlay" id="saveModal">
  <div class="modal">
    <h3>Save Snippet</h3>
    <input type="text" id="snippetName" placeholder="Snippet name..." autofocus>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeSaveDialog()">Cancel</button>
      <button class="btn-primary" onclick="saveSnippet()">Save</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Hidden file input -->
<input type="file" id="fileInput" accept=".sql,.txt" style="display:none" onchange="handleImport(event)">

<script>
// ============================================================
// DATA: SQL Keywords, Functions, SFMC specifics
// ============================================================
const SQL_KEYWORDS = [
  'SELECT','FROM','WHERE','AND','OR','NOT','IN','EXISTS','BETWEEN','LIKE',
  'IS','NULL','AS','ON','JOIN','INNER','LEFT','RIGHT','OUTER','FULL','CROSS',
  'GROUP','BY','ORDER','HAVING','UNION','ALL','DISTINCT','TOP','INSERT','INTO',
  'UPDATE','SET','DELETE','CREATE','TABLE','ALTER','DROP','INDEX','VALUES',
  'CASE','WHEN','THEN','ELSE','END','ASC','DESC','LIMIT','OFFSET','WITH',
  'OVER','PARTITION','ROW_NUMBER','RANK','DENSE_RANK','ROWS','RANGE',
  'PRECEDING','FOLLOWING','UNBOUNDED','CURRENT','ROW','PERCENT','EXCEPT',
  'INTERSECT','DECLARE','BEGIN','RETURN','EXEC','EXECUTE','IF','WHILE',
  'BREAK','CONTINUE','GOTO','PRINT','RAISERROR','TRY','CATCH','THROW',
  'MERGE','USING','MATCHED','OUTPUT','INSERTED','DELETED','PIVOT','UNPIVOT',
  'FETCH','NEXT','FIRST','LAST','ABSOLUTE','RELATIVE','OPEN','CLOSE',
  'DEALLOCATE','CURSOR','FOR','READONLY','IDENTITY','CONSTRAINT','PRIMARY',
  'KEY','FOREIGN','REFERENCES','CHECK','DEFAULT','UNIQUE','CLUSTERED',
  'NONCLUSTERED','NOLOCK','HOLDLOCK','ROWLOCK','TABLOCK','VARCHAR','NVARCHAR',
  'INT','BIGINT','SMALLINT','TINYINT','BIT','DECIMAL','NUMERIC','FLOAT',
  'REAL','DATETIME','DATE','TIME','CHAR','NCHAR','TEXT','NTEXT','IMAGE',
  'MONEY','SMALLMONEY','XML','VARBINARY','BINARY','TIMESTAMP','UNIQUEIDENTIFIER'
];

const SQL_FUNCTIONS = [
  'COUNT','SUM','AVG','MIN','MAX','COALESCE','ISNULL','NULLIF','IIF',
  'LEN','TRIM','LTRIM','RTRIM','UPPER','LOWER','SUBSTRING','REPLACE',
  'CHARINDEX','PATINDEX','STUFF','REVERSE','LEFT','RIGHT','REPLICATE',
  'SPACE','STR','FORMAT','CONCAT','CONCAT_WS','STRING_AGG',
  'CAST','CONVERT','TRY_CAST','TRY_CONVERT',
  'ABS','CEILING','FLOOR','ROUND','POWER','SQRT','SIGN','LOG','LOG10','EXP',
  'RAND','NEWID','CHECKSUM','HASHBYTES',
  'YEAR','MONTH','DAY','HOUR','MINUTE','SECOND',
  'DATEDIFF','DATEPART','DATENAME','EOMONTH','DATEFROMPARTS','ISDATE',
  'SWITCHOFFSET','TODATETIMEOFFSET','SYSDATETIME','SYSUTCDATETIME',
  'ROW_NUMBER','RANK','DENSE_RANK','NTILE','LAG','LEAD',
  'FIRST_VALUE','LAST_VALUE','PERCENT_RANK','CUME_DIST',
  'OBJECT_ID','OBJECT_NAME','SCOPE_IDENTITY','IDENT_CURRENT',
  'ERROR_MESSAGE','ERROR_NUMBER','ERROR_SEVERITY','ERROR_STATE',
  'QUOTENAME','PARSENAME','SCHEMA_NAME','DB_NAME'
];

const SFMC_FUNCTIONS = [
  'DATEADD','GETDATE','GETUTCDATE','SYSDATETIMEOFFSET',
  'HASHBYTES','NEWID','CONVERT','CAST',
  'FORMAT','IIF','CHOOSE','COALESCE','ISNULL'
];

const SFMC_DATA_VIEWS = [
  '_SUBSCRIBERS','_LISTSUBSCRIBERS','_ENTERPRISEATTRIBUTE',
  '_SENT','_OPEN','_CLICK','_BOUNCE','_UNSUBSCRIBE','_COMPLAINT',
  '_JOB','_JOURNEY','_JOURNEYACTIVITY','_SMSMESSAGETRACKING',
  '_SOCIALNETWORKTRACKING','_SOCIALNETWORKIMPRESSIONS',
  '_BUSINESSUNITUNSUBSCRIBES','_FTAF','_SURVEYRESPONSE',
  '_AUTOMATIONACTIVITYINSTANCE','_AUTOMATIONINSTANCE',
  '_PUSHADDRESS','_PUSHTAG','_MOBILEADDRESS','_MOBILESUBSCRIPTION',
  '_SMSMTLOG','_IMPORT','_IMPORTSUBSCRIBERSRESULTS'
];

// ============================================================
// TOKENIZER-BASED SYNTAX HIGHLIGHTER
// ============================================================
function tokenizeSQL(text) {
  const tokens = [];
  let i = 0;
  while (i < text.length) {
    // Single-line comment
    if (text[i] === '-' && text[i+1] === '-') {
      let end = text.indexOf('\n', i);
      if (end === -1) end = text.length;
      tokens.push({ type: 'comment', value: text.substring(i, end) });
      i = end;
      continue;
    }
    // Multi-line comment
    if (text[i] === '/' && text[i+1] === '*') {
      let end = text.indexOf('*/', i + 2);
      if (end === -1) end = text.length; else end += 2;
      tokens.push({ type: 'comment', value: text.substring(i, end) });
      i = end;
      continue;
    }
    // String literal
    if (text[i] === "'") {
      let end = i + 1;
      while (end < text.length) {
        if (text[end] === "'" && text[end+1] === "'") { end += 2; continue; }
        if (text[end] === "'") { end++; break; }
        end++;
      }
      tokens.push({ type: 'string', value: text.substring(i, end) });
      i = end;
      continue;
    }
    // Number
    if (/\d/.test(text[i])) {
      let end = i;
      while (end < text.length && /[\d.]/.test(text[end])) end++;
      tokens.push({ type: 'number', value: text.substring(i, end) });
      i = end;
      continue;
    }
    // Word (keyword / function / identifier)
    if (/[a-zA-Z_]/.test(text[i])) {
      let end = i;
      while (end < text.length && /[a-zA-Z0-9_]/.test(text[end])) end++;
      const word = text.substring(i, end);
      const upper = word.toUpperCase();
      if (SQL_KEYWORDS.includes(upper)) {
        tokens.push({ type: 'keyword', value: word });
      } else if (SFMC_FUNCTIONS.includes(upper)) {
        tokens.push({ type: 'sfmc-function', value: word });
      } else if (SQL_FUNCTIONS.includes(upper)) {
        tokens.push({ type: 'function', value: word });
      } else if (upper.startsWith('_') || SFMC_DATA_VIEWS.includes(upper)) {
        tokens.push({ type: 'dataview', value: word });
      } else {
        tokens.push({ type: 'identifier', value: word });
      }
      i = end;
      continue;
    }
    // Operators
    if (/[=<>!+\-*/%&|^~]/.test(text[i])) {
      tokens.push({ type: 'operator', value: text[i] });
      i++;
      continue;
    }
    // Brackets
    if (/[()[\]]/.test(text[i])) {
      tokens.push({ type: 'bracket', value: text[i] });
      i++;
      continue;
    }
    // Everything else
    tokens.push({ type: 'plain', value: text[i] });
    i++;
  }
  return tokens;
}

function escapeHTML(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function highlightSQL(text) {
  const tokens = tokenizeSQL(text);
  return tokens.map(t => {
    const escaped = escapeHTML(t.value);
    if (t.type === 'plain') return escaped;
    return '<span class="syn-' + t.type + '">' + escaped + '</span>';
  }).join('');
}

// ============================================================
// EDITOR CORE
// ============================================================
const editor = document.getElementById('editor');
const highlightLayer = document.getElementById('highlightLayer');
const lineNumbers = document.getElementById('lineNumbers');
const editorScroll = document.getElementById('editorScroll');

function updateEditor() {
  const text = editor.value;
  // Highlight - add trailing newline so highlight layer matches textarea height
  highlightLayer.innerHTML = highlightSQL(text) + '\n';
  // Line numbers
  const lines = text.split('\n');
  const nums = [];
  for (let i = 1; i <= lines.length; i++) nums.push(i);
  lineNumbers.textContent = nums.join('\n');
  // Resize textarea to match content
  editor.style.height = highlightLayer.scrollHeight + 'px';
  // Status
  updateStatus();
}

function updateStatus() {
  const text = editor.value;
  const lines = text.split('\n');
  const pos = editor.selectionStart;
  let ln = 1, col = 1;
  let count = 0;
  for (let i = 0; i < lines.length; i++) {
    if (count + lines[i].length >= pos) {
      ln = i + 1;
      col = pos - count + 1;
      break;
    }
    count += lines[i].length + 1;
  }
  document.getElementById('statusLines').textContent = 'Ln ' + ln;
  document.getElementById('statusCol').textContent = 'Col ' + col;
  document.getElementById('statusChars').textContent = text.length + ' chars';
  document.getElementById('statusLineCount').textContent = lines.length + (lines.length === 1 ? ' line' : ' lines');
}

// Sync scroll
editorScroll.addEventListener('scroll', function() {
  lineNumbers.style.transform = 'translateY(-' + editorScroll.scrollTop + 'px)';
});

editor.addEventListener('input', updateEditor);
editor.addEventListener('click', updateStatus);
editor.addEventListener('keyup', updateStatus);
editor.addEventListener('scroll', function() {
  editorScroll.scrollTop = editor.scrollTop;
  editorScroll.scrollLeft = editor.scrollLeft;
});

// Tab key inserts spaces
editor.addEventListener('keydown', function(e) {
  if (e.key === 'Tab') {
    e.preventDefault();
    const start = this.selectionStart;
    const end = this.selectionEnd;
    this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
    this.selectionStart = this.selectionEnd = start + 4;
    updateEditor();
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'f') {
    e.preventDefault(); formatSQL();
  } else if ((e.ctrlKey || e.metaKey) && !e.shiftKey && e.key.toLowerCase() === 's') {
    e.preventDefault(); showSaveDialog();
  } else if ((e.ctrlKey || e.metaKey) && !e.shiftKey && e.key.toLowerCase() === 'f') {
    e.preventDefault(); toggleFind();
  } else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'b') {
    e.preventDefault(); togglePanel();
  }
});

// Auto-save to history on blur
editor.addEventListener('blur', function() {
  const text = editor.value.trim();
  if (text.length > 10) addToHistory(text);
});

// ============================================================
// SQL FORMATTER
// ============================================================
function formatSQL() {
  let sql = editor.value.trim();
  if (!sql) return;

  // Simple SQL formatter
  const majorKeywords = ['SELECT','FROM','WHERE','INNER JOIN','LEFT JOIN','RIGHT JOIN','FULL JOIN','CROSS JOIN','JOIN','ON','GROUP BY','ORDER BY','HAVING','UNION ALL','UNION','EXCEPT','INTERSECT','INSERT INTO','UPDATE','SET','DELETE FROM','VALUES','CASE','WHEN','THEN','ELSE','END','AND','OR','LIMIT','OFFSET','WITH'];

  // Normalize whitespace
  sql = sql.replace(/\s+/g, ' ');

  // Add newlines before major keywords
  majorKeywords.forEach(kw => {
    const regex = new RegExp('\\b(' + kw.replace(/ /g, '\\s+') + ')\\b', 'gi');
    sql = sql.replace(regex, '\n$1');
  });

  // Indent after SELECT, add newline+indent for columns
  const lines = sql.split('\n').map(l => l.trim()).filter(l => l);
  const formatted = [];
  let indent = 0;

  for (let line of lines) {
    const upper = line.toUpperCase();
    if (upper.startsWith('SELECT')) {
      formatted.push('    '.repeat(indent) + line);
    } else if (upper.startsWith('FROM') || upper.startsWith('WHERE') || upper.startsWith('GROUP BY') || upper.startsWith('ORDER BY') || upper.startsWith('HAVING')) {
      formatted.push('    '.repeat(indent) + line);
    } else if (upper.startsWith('INNER JOIN') || upper.startsWith('LEFT JOIN') || upper.startsWith('RIGHT JOIN') || upper.startsWith('FULL JOIN') || upper.startsWith('CROSS JOIN') || upper.startsWith('JOIN')) {
      formatted.push('    '.repeat(indent) + line);
    } else if (upper.startsWith('ON')) {
      formatted.push('    '.repeat(indent) + '    ' + line);
    } else if (upper.startsWith('AND') || upper.startsWith('OR')) {
      formatted.push('    '.repeat(indent) + '    ' + line);
    } else if (upper.startsWith('WHEN') || upper.startsWith('THEN') || upper.startsWith('ELSE')) {
      formatted.push('    '.repeat(indent) + '    ' + line);
    } else {
      formatted.push('    '.repeat(indent) + line);
    }
  }

  editor.value = formatted.join('\n');
  updateEditor();
  showToast('SQL formatted', 'success');
}

// ============================================================
// TEMPLATES
// ============================================================
const TEMPLATES = [
  {
    name: 'Deduplicate Subscribers',
    desc: 'Remove duplicate subscribers using ROW_NUMBER()',
    sql: `-- Deduplicate Subscribers by EmailAddress
-- Keeps the most recently added record per email

SELECT
    SubscriberKey,
    EmailAddress,
    FirstName,
    LastName,
    Status,
    DateJoined
FROM (
    SELECT
        s.SubscriberKey,
        s.EmailAddress,
        e.FirstName,
        e.LastName,
        s.Status,
        s.DateJoined,
        ROW_NUMBER() OVER (
            PARTITION BY s.EmailAddress
            ORDER BY s.DateJoined DESC
        ) AS RowNum
    FROM _Subscribers s
    LEFT JOIN _EnterpriseAttribute e
        ON s.SubscriberKey = e.SubscriberKey
    WHERE s.Status = 'Active'
) ranked
WHERE RowNum = 1`
  },
  {
    name: 'Opened Last 30 Days',
    desc: 'Find subscribers who opened emails in last 30 days',
    sql: `-- Subscribers who opened emails in the last 30 days
-- Includes open count and last open date

SELECT TOP 1000
    s.SubscriberKey,
    s.EmailAddress,
    COUNT(o.EventDate) AS TotalOpens,
    MAX(o.EventDate) AS LastOpenDate
FROM _Subscribers s
INNER JOIN _Open o
    ON s.SubscriberKey = o.SubscriberKey
WHERE o.EventDate > DATEADD(day, -30, GETDATE())
    AND s.Status = 'Active'
    AND o.IsUnique = 1
GROUP BY
    s.SubscriberKey,
    s.EmailAddress
HAVING COUNT(o.EventDate) >= 1
ORDER BY TotalOpens DESC`
  },
  {
    name: 'Clicked Not Converted',
    desc: 'Subscribers who clicked but have no conversion record',
    sql: `-- Clicked but not converted
-- Find subscribers who clicked links but aren't in conversion DE

SELECT DISTINCT
    c.SubscriberKey,
    s.EmailAddress,
    c.EventDate AS ClickDate,
    c.URL
FROM _Click c
INNER JOIN _Subscribers s
    ON c.SubscriberKey = s.SubscriberKey
LEFT JOIN [Conversions_DE] conv
    ON c.SubscriberKey = conv.SubscriberKey
WHERE c.EventDate > DATEADD(day, -14, GETDATE())
    AND conv.SubscriberKey IS NULL
    AND s.Status = 'Active'
ORDER BY c.EventDate DESC`
  },
  {
    name: 'Join with Data Extension',
    desc: 'Join subscriber data with a custom Data Extension',
    sql: `-- Join subscribers with custom Data Extension
-- Replace [Your_DataExtension] with actual DE name

SELECT
    s.SubscriberKey,
    s.EmailAddress,
    de.CustomField1,
    de.CustomField2,
    de.PurchaseDate,
    de.TotalAmount
FROM _Subscribers s
INNER JOIN [Your_DataExtension] de
    ON s.SubscriberKey = de.SubscriberKey
WHERE s.Status = 'Active'
    AND de.PurchaseDate > DATEADD(month, -3, GETDATE())
ORDER BY de.TotalAmount DESC`
  },
  {
    name: 'Engagement Scoring',
    desc: 'Calculate engagement scores with weighted activities',
    sql: `-- Engagement Scoring Model
-- Weighted scoring: Opens=1pt, Clicks=3pts, Recent=2x multiplier

SELECT
    s.SubscriberKey,
    s.EmailAddress,
    ISNULL(opens.OpenCount, 0) AS OpenCount,
    ISNULL(clicks.ClickCount, 0) AS ClickCount,
    CASE
        WHEN ISNULL(clicks.ClickCount, 0) >= 5
            AND ISNULL(opens.OpenCount, 0) >= 10
            THEN 'Highly Engaged'
        WHEN ISNULL(clicks.ClickCount, 0) >= 2
            OR ISNULL(opens.OpenCount, 0) >= 5
            THEN 'Engaged'
        WHEN ISNULL(opens.OpenCount, 0) >= 1
            THEN 'Somewhat Engaged'
        ELSE 'Disengaged'
    END AS EngagementTier,
    (ISNULL(opens.OpenCount, 0) * 1)
    + (ISNULL(clicks.ClickCount, 0) * 3)
    AS EngagementScore
FROM _Subscribers s
LEFT JOIN (
    SELECT SubscriberKey, COUNT(*) AS OpenCount
    FROM _Open
    WHERE EventDate > DATEADD(day, -90, GETDATE())
        AND IsUnique = 1
    GROUP BY SubscriberKey
) opens ON s.SubscriberKey = opens.SubscriberKey
LEFT JOIN (
    SELECT SubscriberKey, COUNT(*) AS ClickCount
    FROM _Click
    WHERE EventDate > DATEADD(day, -90, GETDATE())
        AND IsUnique = 1
    GROUP BY SubscriberKey
) clicks ON s.SubscriberKey = clicks.SubscriberKey
WHERE s.Status = 'Active'
ORDER BY EngagementScore DESC`
  },
  {
    name: 'Bounce Analysis',
    desc: 'Analyze bounces by category and type',
    sql: `-- Bounce Analysis by Category
-- Identify problematic email addresses

SELECT
    b.BounceCategory,
    b.BounceSubcategory,
    b.SMTPBounceReason,
    COUNT(*) AS BounceCount,
    COUNT(DISTINCT b.SubscriberKey) AS UniqueSubscribers
FROM _Bounce b
INNER JOIN _Subscribers s
    ON b.SubscriberKey = s.SubscriberKey
WHERE b.EventDate > DATEADD(day, -30, GETDATE())
GROUP BY
    b.BounceCategory,
    b.BounceSubcategory,
    b.SMTPBounceReason
ORDER BY BounceCount DESC`
  },
  {
    name: 'Unsubscribe Trends',
    desc: 'Track unsubscribe patterns over time',
    sql: `-- Unsubscribe Trends by Week
-- Monitor unsubscribe velocity

SELECT
    DATEPART(year, u.EventDate) AS UnsubYear,
    DATEPART(week, u.EventDate) AS UnsubWeek,
    DATEADD(day,
        -(DATEPART(weekday, u.EventDate) - 1),
        CAST(u.EventDate AS DATE)
    ) AS WeekStarting,
    COUNT(*) AS UnsubCount,
    COUNT(DISTINCT u.SubscriberKey) AS UniqueUnsubs
FROM _Unsubscribe u
WHERE u.EventDate > DATEADD(month, -6, GETDATE())
GROUP BY
    DATEPART(year, u.EventDate),
    DATEPART(week, u.EventDate),
    DATEADD(day,
        -(DATEPART(weekday, u.EventDate) - 1),
        CAST(u.EventDate AS DATE)
    )
ORDER BY UnsubYear DESC, UnsubWeek DESC`
  },
  {
    name: 'Journey Entry Audience',
    desc: 'Build a journey entry audience with engagement criteria',
    sql: `-- Journey Entry Audience Builder
-- Engaged subscribers who haven't been contacted recently

SELECT
    s.SubscriberKey,
    s.EmailAddress
FROM _Subscribers s
INNER JOIN (
    SELECT SubscriberKey
    FROM _Open
    WHERE EventDate > DATEADD(day, -60, GETDATE())
        AND IsUnique = 1
    GROUP BY SubscriberKey
    HAVING COUNT(*) >= 2
) engaged ON s.SubscriberKey = engaged.SubscriberKey
WHERE s.Status = 'Active'
    AND s.SubscriberKey NOT IN (
        SELECT DISTINCT SubscriberKey
        FROM _Sent
        WHERE EventDate > DATEADD(day, -7, GETDATE())
    )
    AND s.SubscriberKey NOT IN (
        SELECT DISTINCT SubscriberKey
        FROM _Bounce
        WHERE EventDate > DATEADD(day, -30, GETDATE())
            AND BounceCategory = 'Hard bounce'
    )`
  },
  {
    name: 'DE Cleanup',
    desc: 'Find and remove duplicate or incomplete records',
    sql: `-- Data Extension Cleanup
-- Find duplicates and records with missing required fields

-- Step 1: Find duplicates
SELECT
    SubscriberKey,
    EmailAddress,
    COUNT(*) AS DuplicateCount
FROM [Your_DataExtension]
GROUP BY SubscriberKey, EmailAddress
HAVING COUNT(*) > 1

/* Step 2: Find records with NULL required fields
SELECT
    SubscriberKey,
    EmailAddress,
    FirstName,
    LastName
FROM [Your_DataExtension]
WHERE EmailAddress IS NULL
    OR LEN(RTRIM(EmailAddress)) = 0
    OR SubscriberKey IS NULL
    OR LEN(RTRIM(SubscriberKey)) = 0
ORDER BY SubscriberKey
*/`
  },
  {
    name: 'Date Segmentation',
    desc: 'Segment subscribers by date ranges and recency',
    sql: `-- Date-Based Segmentation
-- Categorize subscribers by their last activity

SELECT
    s.SubscriberKey,
    s.EmailAddress,
    MAX(o.EventDate) AS LastActivity,
    CASE
        WHEN MAX(o.EventDate) > DATEADD(day, -7, GETDATE())
            THEN '1 - Active (Last 7 days)'
        WHEN MAX(o.EventDate) > DATEADD(day, -30, GETDATE())
            THEN '2 - Recent (8-30 days)'
        WHEN MAX(o.EventDate) > DATEADD(day, -90, GETDATE())
            THEN '3 - Lapsing (31-90 days)'
        WHEN MAX(o.EventDate) > DATEADD(day, -180, GETDATE())
            THEN '4 - At Risk (91-180 days)'
        ELSE '5 - Inactive (180+ days)'
    END AS ActivitySegment,
    DATEDIFF(day, MAX(o.EventDate), GETDATE()) AS DaysSinceActivity
FROM _Subscribers s
LEFT JOIN _Open o
    ON s.SubscriberKey = o.SubscriberKey
WHERE s.Status = 'Active'
GROUP BY s.SubscriberKey, s.EmailAddress
ORDER BY LastActivity DESC`
  },
  {
    name: 'Cross-DE Lookup',
    desc: 'Join data across multiple Data Extensions',
    sql: `-- Cross-DE Lookup
-- Combine data from multiple Data Extensions

SELECT
    c.SubscriberKey,
    c.EmailAddress,
    c.FirstName,
    c.LastName,
    p.ProductName,
    p.PurchaseDate,
    p.Amount,
    pref.PreferredChannel,
    pref.OptInDate
FROM [Contacts_DE] c
INNER JOIN [Purchases_DE] p
    ON c.SubscriberKey = p.SubscriberKey
LEFT JOIN [Preferences_DE] pref
    ON c.SubscriberKey = pref.SubscriberKey
WHERE p.PurchaseDate > DATEADD(month, -6, GETDATE())
    AND p.Amount > 0
ORDER BY p.PurchaseDate DESC, p.Amount DESC`
  },
  {
    name: 'Send Performance',
    desc: 'Analyze email send performance with open and click rates',
    sql: `-- Send Performance Report
-- Calculate open and click rates per job/send

SELECT
    j.JobID,
    j.EmailName,
    j.DeliveredTime,
    COUNT(DISTINCT st.SubscriberKey) AS TotalSent,
    COUNT(DISTINCT o.SubscriberKey) AS UniqueOpens,
    COUNT(DISTINCT c.SubscriberKey) AS UniqueClicks,
    COUNT(DISTINCT b.SubscriberKey) AS Bounces,
    CAST(
        ROUND(
            COUNT(DISTINCT o.SubscriberKey) * 100.0
            / NULLIF(COUNT(DISTINCT st.SubscriberKey), 0),
        2) AS DECIMAL(5,2)
    ) AS OpenRate,
    CAST(
        ROUND(
            COUNT(DISTINCT c.SubscriberKey) * 100.0
            / NULLIF(COUNT(DISTINCT st.SubscriberKey), 0),
        2) AS DECIMAL(5,2)
    ) AS ClickRate
FROM _Job j
INNER JOIN _Sent st ON j.JobID = st.JobID
LEFT JOIN _Open o ON st.JobID = o.JobID
    AND st.SubscriberKey = o.SubscriberKey
    AND o.IsUnique = 1
LEFT JOIN _Click c ON st.JobID = c.JobID
    AND st.SubscriberKey = c.SubscriberKey
    AND c.IsUnique = 1
LEFT JOIN _Bounce b ON st.JobID = b.JobID
    AND st.SubscriberKey = b.SubscriberKey
WHERE j.DeliveredTime > DATEADD(day, -30, GETDATE())
GROUP BY j.JobID, j.EmailName, j.DeliveredTime
ORDER BY j.DeliveredTime DESC`
  },
  {
    name: 'A/B Test Comparison',
    desc: 'Compare A/B test results across send variants',
    sql: `-- A/B Test Results Comparison
-- Compare performance of test variants

SELECT
    j.EmailName,
    j.JobID,
    j.DeliveredTime,
    COUNT(DISTINCT st.SubscriberKey) AS Sent,
    COUNT(DISTINCT o.SubscriberKey) AS Opens,
    COUNT(DISTINCT c.SubscriberKey) AS Clicks,
    CAST(ROUND(
        COUNT(DISTINCT o.SubscriberKey) * 100.0
        / NULLIF(COUNT(DISTINCT st.SubscriberKey), 0), 2
    ) AS DECIMAL(5,2)) AS OpenPct,
    CAST(ROUND(
        COUNT(DISTINCT c.SubscriberKey) * 100.0
        / NULLIF(COUNT(DISTINCT o.SubscriberKey), 0), 2
    ) AS DECIMAL(5,2)) AS ClickToOpenPct
FROM _Job j
INNER JOIN _Sent st ON j.JobID = st.JobID
LEFT JOIN _Open o ON j.JobID = o.JobID
    AND st.SubscriberKey = o.SubscriberKey
    AND o.IsUnique = 1
LEFT JOIN _Click c ON j.JobID = c.JobID
    AND st.SubscriberKey = c.SubscriberKey
    AND c.IsUnique = 1
WHERE j.EmailName LIKE '%ABTest%'
    AND j.DeliveredTime > DATEADD(day, -30, GETDATE())
GROUP BY j.EmailName, j.JobID, j.DeliveredTime
ORDER BY j.DeliveredTime DESC, OpenPct DESC`
  },
  {
    name: 'Preference Center',
    desc: 'Query and manage subscriber preferences',
    sql: `-- Preference Center Query
-- Get subscriber preferences for targeted sends

SELECT
    s.SubscriberKey,
    s.EmailAddress,
    pref.NewsletterOptIn,
    pref.ProductUpdatesOptIn,
    pref.WeeklyDigestOptIn,
    pref.PreferredFrequency,
    pref.PreferredCategory,
    pref.LastUpdated
FROM _Subscribers s
INNER JOIN [Preference_Center_DE] pref
    ON s.SubscriberKey = pref.SubscriberKey
WHERE s.Status = 'Active'
    AND pref.NewsletterOptIn = 1
    AND (
        pref.PreferredFrequency = 'Weekly'
        OR pref.PreferredFrequency = 'Daily'
    )
ORDER BY pref.LastUpdated DESC`
  },
  {
    name: 'Win-Back Audience',
    desc: 'Identify inactive subscribers for win-back campaigns',
    sql: `-- Win-Back Audience
-- Subscribers who were active but have gone silent

SELECT
    s.SubscriberKey,
    s.EmailAddress,
    MAX(o.EventDate) AS LastOpenDate,
    DATEDIFF(day, MAX(o.EventDate), GETDATE()) AS DaysSinceLastOpen
FROM _Subscribers s
INNER JOIN _Open o
    ON s.SubscriberKey = o.SubscriberKey
WHERE s.Status = 'Active'
    AND NOT EXISTS (
        SELECT 1 FROM _Open o2
        WHERE o2.SubscriberKey = s.SubscriberKey
            AND o2.EventDate > DATEADD(day, -60, GETDATE())
    )
    AND EXISTS (
        SELECT 1 FROM _Open o3
        WHERE o3.SubscriberKey = s.SubscriberKey
            AND o3.EventDate > DATEADD(day, -365, GETDATE())
    )
    AND s.SubscriberKey NOT IN (
        SELECT SubscriberKey
        FROM _Unsubscribe
        WHERE EventDate > DATEADD(day, -365, GETDATE())
    )
GROUP BY s.SubscriberKey, s.EmailAddress
HAVING DATEDIFF(day, MAX(o.EventDate), GETDATE()) BETWEEN 60 AND 180
ORDER BY LastOpenDate DESC`
  }
];

// ============================================================
// DATA VIEWS REFERENCE
// ============================================================
const DATA_VIEWS = {
  '_Subscribers': [
    { name: 'SubscriberKey', type: 'nvarchar', desc: 'Unique subscriber identifier' },
    { name: 'EmailAddress', type: 'nvarchar', desc: 'Email address' },
    { name: 'Status', type: 'nvarchar', desc: 'Active, Held, Unsubscribed, Bounced' },
    { name: 'DateJoined', type: 'datetime', desc: 'Date subscriber was added' },
    { name: 'DateUnsubscribed', type: 'datetime', desc: 'Date of unsubscribe' },
    { name: 'DateHeld', type: 'datetime', desc: 'Date status set to Held' },
    { name: 'Domain', type: 'nvarchar', desc: 'Email domain' }
  ],
  '_Sent': [
    { name: 'SubscriberKey', type: 'nvarchar', desc: 'Subscriber key' },
    { name: 'JobID', type: 'int', desc: 'Send job ID' },
    { name: 'EventDate', type: 'datetime', desc: 'Date/time of send' },
    { name: 'BatchID', type: 'int', desc: 'Batch identifier' },
    { name: 'ListID', type: 'int', desc: 'List ID used' },
    { name: 'TriggeredSendExternalKey', type: 'nvarchar', desc: 'Triggered send key' }
  ],
  '_Open': [
    { name: 'SubscriberKey', type: 'nvarchar', desc: 'Subscriber key' },
    { name: 'JobID', type: 'int', desc: 'Send job ID' },
    { name: 'EventDate', type: 'datetime', desc: 'Open event timestamp' },
    { name: 'IsUnique', type: 'bit', desc: 'First open = 1' },
    { name: 'ListID', type: 'int', desc: 'List ID' },
    { name: 'BatchID', type: 'int', desc: 'Batch ID' },
    { name: 'TriggeredSendExternalKey', type: 'nvarchar', desc: 'Triggered send key' }
  ],
  '_Click': [
    { name: 'SubscriberKey', type: 'nvarchar', desc: 'Subscriber key' },
    { name: 'JobID', type: 'int', desc: 'Send job ID' },
    { name: 'EventDate', type: 'datetime', desc: 'Click event timestamp' },
    { name: 'URL', type: 'nvarchar', desc: 'Clicked URL' },
    { name: 'LinkName', type: 'nvarchar', desc: 'Link alias' },
    { name: 'IsUnique', type: 'bit', desc: 'First click = 1' },
    { name: 'ListID', type: 'int', desc: 'List ID' },
    { name: 'BatchID', type: 'int', desc: 'Batch ID' }
  ],
  '_Bounce': [
    { name: 'SubscriberKey', type: 'nvarchar', desc: 'Subscriber key' },
    { name: 'JobID', type: 'int', desc: 'Send job ID' },
    { name: 'EventDate', type: 'datetime', desc: 'Bounce timestamp' },
    { name: 'BounceCategory', type: 'nvarchar', desc: 'Hard/Soft bounce' },
    { name: 'BounceSubcategory', type: 'nvarchar', desc: 'Specific bounce reason' },
    { name: 'SMTPBounceReason', type: 'nvarchar', desc: 'SMTP error message' },
    { name: 'SMTPCode', type: 'int', desc: 'SMTP response code' }
  ],
  '_Unsubscribe': [
    { name: 'SubscriberKey', type: 'nvarchar', desc: 'Subscriber key' },
    { name: 'JobID', type: 'int', desc: 'Send job ID' },
    { name: 'EventDate', type: 'datetime', desc: 'Unsub timestamp' },
    { name: 'ListID', type: 'int', desc: 'List ID' },
    { name: 'BatchID', type: 'int', desc: 'Batch ID' },
    { name: 'Reason', type: 'nvarchar', desc: 'Unsub reason if provided' }
  ],
  '_Job': [
    { name: 'JobID', type: 'int', desc: 'Unique job identifier' },
    { name: 'EmailName', type: 'nvarchar', desc: 'Name of the email' },
    { name: 'EmailSubject', type: 'nvarchar', desc: 'Subject line' },
    { name: 'DeliveredTime', type: 'datetime', desc: 'Send completion time' },
    { name: 'JobType', type: 'nvarchar', desc: 'Type of job' },
    { name: 'JobStatus', type: 'nvarchar', desc: 'Completed, Error, etc.' },
    { name: 'TriggeredSendExternalKey', type: 'nvarchar', desc: 'Triggered send key' }
  ],
  '_Complaint': [
    { name: 'SubscriberKey', type: 'nvarchar', desc: 'Subscriber key' },
    { name: 'JobID', type: 'int', desc: 'Job ID' },
    { name: 'EventDate', type: 'datetime', desc: 'Complaint timestamp' },
    { name: 'ListID', type: 'int', desc: 'List ID' },
    { name: 'BatchID', type: 'int', desc: 'Batch ID' }
  ],
  '_ListSubscribers': [
    { name: 'SubscriberKey', type: 'nvarchar', desc: 'Subscriber key' },
    { name: 'ListID', type: 'int', desc: 'List identifier' },
    { name: 'ListName', type: 'nvarchar', desc: 'Name of the list' },
    { name: 'Status', type: 'nvarchar', desc: 'Status on this list' },
    { name: 'DateJoined', type: 'datetime', desc: 'Date added to list' },
    { name: 'DateUnsubscribed', type: 'datetime', desc: 'Date removed' }
  ],
  '_Journey': [
    { name: 'VersionID', type: 'nvarchar', desc: 'Journey version ID' },
    { name: 'JourneyID', type: 'nvarchar', desc: 'Journey identifier' },
    { name: 'JourneyName', type: 'nvarchar', desc: 'Journey name' },
    { name: 'VersionNumber', type: 'int', desc: 'Version number' },
    { name: 'CreatedDate', type: 'datetime', desc: 'Creation date' },
    { name: 'LastPublishedDate', type: 'datetime', desc: 'Last published' },
    { name: 'JourneyStatus', type: 'nvarchar', desc: 'Draft, Running, etc.' }
  ],
  '_JourneyActivity': [
    { name: 'VersionID', type: 'nvarchar', desc: 'Journey version ID' },
    { name: 'ActivityID', type: 'nvarchar', desc: 'Activity identifier' },
    { name: 'ActivityName', type: 'nvarchar', desc: 'Activity name' },
    { name: 'ActivityType', type: 'nvarchar', desc: 'Email, Wait, Decision, etc.' },
    { name: 'ActivityExternalKey', type: 'nvarchar', desc: 'External key' }
  ]
};

// ============================================================
// PANEL FUNCTIONS
// ============================================================
function togglePanel() {
  document.getElementById('sidePanel').classList.toggle('collapsed');
}

function switchPanelTab(tab) {
  document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel-section').forEach(s => s.classList.remove('active'));
  document.querySelector('[onclick="switchPanelTab(\'' + tab + '\')"]').classList.add('active');
  document.getElementById('sec-' + tab).classList.add('active');

  if (tab === 'snippets') renderSnippets();
  if (tab === 'history') renderHistory();
}

// Templates
function renderTemplates(filter) {
  const container = document.getElementById('tplList');
  filter = (filter || '').toLowerCase();
  container.innerHTML = TEMPLATES
    .filter(t => !filter || t.name.toLowerCase().includes(filter) || t.desc.toLowerCase().includes(filter))
    .map((t, i) => '<div class="tpl-card" onclick="loadTemplate(' + TEMPLATES.indexOf(t) + ')">' +
      '<h4>' + escapeHTML(t.name) + '</h4>' +
      '<p>' + escapeHTML(t.desc) + '</p></div>').join('');
}

function filterTemplates() {
  renderTemplates(document.getElementById('tplSearch').value);
}

function loadTemplate(idx) {
  const tpl = TEMPLATES[idx];
  editor.value = tpl.sql;
  updateEditor();
  addToHistory(tpl.sql);
  showToast('Loaded: ' + tpl.name, 'success');
  editor.focus();
}

// Snippets
function renderSnippets() {
  const snippets = getSnippets();
  const container = document.getElementById('snippetList');
  if (snippets.length === 0) {
    container.innerHTML = '<p style="font-size:12px;color:var(--text-muted);text-align:center;padding:20px">No saved snippets yet.<br>Use Ctrl+S to save.</p>';
    return;
  }
  container.innerHTML = snippets.map((sn, i) =>
    '<div class="snippet-item" onclick="loadSnippet(' + i + ')">' +
    '<span class="sn-name">' + escapeHTML(sn.name) + '</span>' +
    '<span class="sn-date">' + formatDate(sn.date) + '</span>' +
    '<button class="sn-del" onclick="event.stopPropagation();deleteSnippet(' + i + ')" title="Delete">&times;</button>' +
    '</div>'
  ).join('');
}

function getSnippets() {
  try { return JSON.parse(localStorage.getItem('sfmc_qsp_snippets') || '[]'); } catch { return []; }
}

function saveSnippetData(name) {
  const snippets = getSnippets();
  snippets.unshift({ name, sql: editor.value, date: Date.now() });
  localStorage.setItem('sfmc_qsp_snippets', JSON.stringify(snippets));
}

function loadSnippet(i) {
  const snippets = getSnippets();
  if (snippets[i]) {
    editor.value = snippets[i].sql;
    updateEditor();
    showToast('Loaded: ' + snippets[i].name, 'success');
  }
}

function deleteSnippet(i) {
  const snippets = getSnippets();
  snippets.splice(i, 1);
  localStorage.setItem('sfmc_qsp_snippets', JSON.stringify(snippets));
  renderSnippets();
  showToast('Snippet deleted', '');
}

// Data Views
function renderDataViews(filter) {
  const container = document.getElementById('dvList');
  filter = (filter || '').toLowerCase();
  let html = '';
  for (const [name, fields] of Object.entries(DATA_VIEWS)) {
    if (filter && !name.toLowerCase().includes(filter) && !fields.some(f => f.name.toLowerCase().includes(filter))) continue;
    html += '<div class="dv-group">' +
      '<div class="dv-header" onclick="this.parentElement.classList.toggle(\'open\')">' +
      escapeHTML(name) + '<span class="arrow">&#9654;</span></div>' +
      '<div class="dv-fields">' +
      fields.map(f =>
        '<div class="dv-field" onclick="insertAtCursor(\'' + f.name + '\')" title="' + escapeHTML(f.desc) + '">' +
        '<span class="f-name">' + escapeHTML(f.name) + '</span>' +
        '<span class="f-type">' + f.type + '</span>' +
        '</div>'
      ).join('') +
      '</div></div>';
  }
  container.innerHTML = html;
}

function filterDataViews() {
  renderDataViews(document.getElementById('dvSearch').value);
}

function insertAtCursor(text) {
  editor.focus();
  const start = editor.selectionStart;
  const end = editor.selectionEnd;
  editor.value = editor.value.substring(0, start) + text + editor.value.substring(end);
  editor.selectionStart = editor.selectionEnd = start + text.length;
  updateEditor();
}

// History
function addToHistory(sql) {
  if (!sql || sql.trim().length < 10) return;
  let hist;
  try { hist = JSON.parse(localStorage.getItem('sfmc_qsp_history') || '[]'); } catch { hist = []; }
  // Dedupe
  hist = hist.filter(h => h.sql !== sql);
  hist.unshift({ sql, date: Date.now() });
  if (hist.length > 30) hist = hist.slice(0, 30);
  localStorage.setItem('sfmc_qsp_history', JSON.stringify(hist));
}

function renderHistory() {
  let hist;
  try { hist = JSON.parse(localStorage.getItem('sfmc_qsp_history') || '[]'); } catch { hist = []; }
  const container = document.getElementById('histList');
  if (hist.length === 0) {
    container.innerHTML = '<p style="font-size:12px;color:var(--text-muted);text-align:center;padding:20px">No history yet.</p>';
    return;
  }
  container.innerHTML = hist.map((h, i) =>
    '<div class="hist-item" onclick="loadHistory(' + i + ')">' +
    '<div class="h-preview">' + escapeHTML(h.sql.substring(0, 80)) + '</div>' +
    '<div class="h-time">' + formatDate(h.date) + '</div>' +
    '</div>'
  ).join('');
}

function loadHistory(i) {
  let hist;
  try { hist = JSON.parse(localStorage.getItem('sfmc_qsp_history') || '[]'); } catch { hist = []; }
  if (hist[i]) {
    editor.value = hist[i].sql;
    updateEditor();
    showToast('Loaded from history', 'success');
  }
}

// ============================================================
// ACTIONS
// ============================================================
function copyToClipboard() {
  navigator.clipboard.writeText(editor.value).then(() => {
    showToast('Copied to clipboard', 'success');
  }).catch(() => {
    // Fallback
    editor.select();
    document.execCommand('copy');
    showToast('Copied to clipboard', 'success');
  });
}

function exportSQL() {
  const text = editor.value;
  if (!text.trim()) { showToast('Nothing to export', 'error'); return; }
  const blob = new Blob([text], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'query_' + new Date().toISOString().slice(0,10) + '.sql';
  a.click();
  URL.revokeObjectURL(a.href);
  showToast('Exported as .sql', 'success');
}

function importSQL() {
  document.getElementById('fileInput').click();
}

function handleImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    editor.value = ev.target.result;
    updateEditor();
    showToast('Imported: ' + file.name, 'success');
  };
  reader.readAsText(file);
  e.target.value = '';
}

function clearEditor() {
  if (editor.value.trim() && !confirm('Clear the editor?')) return;
  editor.value = '';
  updateEditor();
}

// Save dialog
function showSaveDialog() {
  if (!editor.value.trim()) { showToast('Nothing to save', 'error'); return; }
  document.getElementById('saveModal').classList.add('visible');
  const input = document.getElementById('snippetName');
  input.value = '';
  input.focus();
}

function closeSaveDialog() {
  document.getElementById('saveModal').classList.remove('visible');
}

function saveSnippet() {
  const name = document.getElementById('snippetName').value.trim();
  if (!name) { showToast('Enter a name', 'error'); return; }
  saveSnippetData(name);
  closeSaveDialog();
  showToast('Saved: ' + name, 'success');
}

document.getElementById('snippetName').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') saveSnippet();
  if (e.key === 'Escape') closeSaveDialog();
});

document.getElementById('saveModal').addEventListener('click', function(e) {
  if (e.target === this) closeSaveDialog();
});

// Find & Replace
function toggleFind() {
  const bar = document.getElementById('findBar');
  bar.classList.toggle('visible');
  if (bar.classList.contains('visible')) {
    document.getElementById('findInput').focus();
  }
}

function doFind() {
  const query = document.getElementById('findInput').value;
  if (!query) { document.getElementById('findCount').textContent = ''; return; }
  const text = editor.value;
  let count = 0, idx = -1;
  while ((idx = text.indexOf(query, idx + 1)) !== -1) count++;
  document.getElementById('findCount').textContent = count + ' found';
  // Select first occurrence
  const first = text.indexOf(query);
  if (first !== -1) {
    editor.focus();
    editor.setSelectionRange(first, first + query.length);
  }
}

function doReplace() {
  const find = document.getElementById('findInput').value;
  const repl = document.getElementById('replaceInput').value;
  if (!find) return;
  const start = editor.value.indexOf(find, editor.selectionStart);
  if (start === -1) return;
  editor.value = editor.value.substring(0, start) + repl + editor.value.substring(start + find.length);
  editor.setSelectionRange(start + repl.length, start + repl.length);
  updateEditor();
  doFind();
}

function doReplaceAll() {
  const find = document.getElementById('findInput').value;
  const repl = document.getElementById('replaceInput').value;
  if (!find) return;
  const count = editor.value.split(find).length - 1;
  editor.value = editor.value.split(find).join(repl);
  updateEditor();
  document.getElementById('findCount').textContent = count + ' replaced';
}

// Theme
function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', isDark ? 'light' : 'dark');
  document.getElementById('themeBtn').innerHTML = isDark ? '&#9728; Light' : '&#9790; Dark';
  localStorage.setItem('sfmc_qsp_theme', isDark ? 'light' : 'dark');
}

// Toast
function showToast(msg, type) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast visible ' + (type || '');
  clearTimeout(toast._timeout);
  toast._timeout = setTimeout(() => toast.className = 'toast', 2000);
}

// Utility
function formatDate(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  const now = new Date();
  const diff = now - d;
  if (diff < 60000) return 'Just now';
  if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
  return d.toLocaleDateString();
}

// ============================================================
// INIT
// ============================================================
(function init() {
  // Load theme
  const savedTheme = localStorage.getItem('sfmc_qsp_theme');
  if (savedTheme) {
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.getElementById('themeBtn').innerHTML = savedTheme === 'dark' ? '&#9790; Dark' : '&#9728; Light';
  }

  // Render panels
  renderTemplates();
  renderDataViews();

  // Load default sample query
  editor.value = `-- SFMC Query Studio Pro
-- Find engaged subscribers from the last 30 days

SELECT TOP 1000
    s.SubscriberKey,
    s.EmailAddress,
    s.FirstName,
    s.LastName,
    COUNT(o.EventDate) AS TotalOpens,
    MAX(o.EventDate) AS LastOpenDate
FROM _Subscribers s
INNER JOIN _Open o
    ON s.SubscriberKey = o.SubscriberKey
WHERE o.EventDate > DATEADD(day, -30, GETDATE())
    AND s.Status = 'Active'
GROUP BY
    s.SubscriberKey,
    s.EmailAddress,
    s.FirstName,
    s.LastName
HAVING COUNT(o.EventDate) >= 3
ORDER BY TotalOpens DESC`;

  updateEditor();
  editor.focus();
})();
</script>
</body>
</html>
